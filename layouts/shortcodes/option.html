{{- $ref := .Get "ref" -}}
{{- $amount := .Get "amount" | default 0 -}}
{{- $constant := .Get "constant" | default 0 -}}
{{- $default := .Get "default" | default "false" -}}

{{- /* Parse ref format: "8230201.champignons" -> category "8230201", key "champignons" */ -}}
{{- $refParts := split $ref "." -}}
{{- $categoryId := index $refParts 0 -}}

{{- /* Convert category ID to folder path: 8230201 -> 08/23/02 */ -}}
{{- $catNum := int $categoryId -}}
{{- $l1Str := printf "%02d" (div $catNum 1000000) -}}
{{- $l2Str := printf "%02d" (mod (div $catNum 10000) 100) -}}
{{- $l3Str := printf "%02d" (mod (div $catNum 100) 100) -}}

{{- /* Look up ingredient from nested data structure */ -}}
{{- $ingredient := "" -}}
{{- with index site.Data.ingredients $l1Str -}}
  {{- with index . $l2Str -}}
    {{- with index . $l3Str -}}
      {{- $ingredient = index . $ref -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Get values from global data, with fallbacks */ -}}
{{- $unit := "" -}}
{{- $name := $ref -}}
{{- $plural := $ref -}}
{{- $posthof := "" -}}
{{- $price := "" -}}
{{- $altUnits := "" -}}

{{- with $ingredient -}}
  {{- $unit = .unit | default "" -}}
  {{- $name = .name | default $ref -}}
  {{- $plural = .plural | default $name -}}
  {{- $posthof = .posthof | default "" -}}
  {{- $price = .price | default "" -}}
  {{- $altUnits = .altUnits | default "" -}}
{{- end -}}

<option
  data-amount="{{ $amount }}"
  data-constant="{{ $constant }}"
  data-unit="{{ $unit }}"
  data-name="{{ $name }}"
  data-plural="{{ $plural }}"
  {{ if $posthof }}data-posthof="{{ $posthof | jsonify }}"{{ end }}
  {{ if $price }}data-price="{{ $price }}"{{ end }}
  {{ if $altUnits }}data-alt-units="{{ $altUnits | jsonify }}"{{ end }}
  {{ if eq $default "true" }}selected{{ end }}>
  {{- $name -}}
</option>
